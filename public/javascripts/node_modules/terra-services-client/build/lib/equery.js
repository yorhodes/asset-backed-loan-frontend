(function(){var q,r=function(f,a){return function(){return f.apply(a,arguments)}},k=[].slice,t=[].indexOf||function(f){for(var a=0,b=this.length;a<b;a++)if(a in this&&this[a]===f)return a;return-1};q=function(){function f(){this.create_listener=r(this.create_listener,this);var a,b,c;a=require("web3");this.web3=null!=this.web3?new a(web3.currentProvider):new a(new a.providers.HttpProvider(this.node_address(this.config.node.ip,this.config.node.port)));if(!this.web3.isConnected())throw"could not connect to ethereum node on localhost. exiting";
this.eth=this.web3.eth;this.coinbase=this.eth.coinbase;c=this.contracts;for(b in c)a=c[b],this["_"+b]=this.contract(a),this[b]=this.contract_agent(b);c=this.users;for(b in c)a=c[b],this[b]=this.user_agent(a);this.events_fired=[]}f.prototype.block_time=17;f.prototype.block_time_ms=17E3;f.prototype.config={node:{ip:"127.0.0.1",port:"8545"}};f.prototype.user_agent=function(a){var b,c;b=this;c={};c.address=a;c.send=function(a,c){var d;null==c&&(c=function(a){return console.log(a)});d={from:b.account(),
to:this.address,value:a};return b.eth.sendTransaction(d,function(a,d){return b.check_mined(d,c)})};return c};f.prototype.contract_agent=function(a){var b,c,g,e,d;a="_"+a;b={};e=this[a].abi;c=0;for(g=e.length;c<g;c++)if(d=e[c],"event"===d.type||"function"===d.type){b[d.name]={};var h=b,l=d.name;a:{switch(!1){case "event"!==d.type:d=this.create_listener(a,d.name);break a;case "function"!==d.type:d=this.create_method(a,d.name,d.constant);break a}d=void 0}h[l]=d}b.address=this[a].address;b.get_balance=
function(a){return function(){return a.decode(a.eth.getBalance(b.address))}}(this);return b};f.prototype.create_listener=function(a,b){return{listen:function(c){return function(g){return c[a][b].listen(function(){var a,b,h;a=2<=arguments.length?k.call(arguments,0,b=arguments.length-1):(b=0,[]);h=arguments[b++];b=c.web3.sha3(c.encode(h));return 0>t.call(c.events_fired,b)?(c.events_fired.push(b),g.apply(null,k.call(a).concat([h]))):console.log("doublefire",b)})}}(this)}};f.prototype.create_method=function(a,
b,c){return c?function(c){return function(){var e,d,h;e=2<=arguments.length?k.call(arguments,0,d=arguments.length-1):(d=0,[]);d=arguments[d++];return(h=c[a][b]).local.apply(h,k.call(e).concat([d]))}}(this):function(c){return function(){var e,d,h;e=1<=arguments.length?k.call(arguments,0):[];return 0===e.length?(console.error("Please call with a callback specified"),c[a][b].remote(function(){var a;a=1<=arguments.length?k.call(arguments,0):[];return console.log.apply(console,a)})):1===e.length?c[a][b].remote(e[0]):
"object"===typeof e[0]?(d=c[a][b]).send.apply(d,e):(h=c[a][b]).remote.apply(h,e)}}(this)};f.prototype.clean_return_value=function(a){var b;try{b=this.decode(a)}catch(c){b=a}return b};f.prototype.contract=function(a){var b,c,g,e,d;b=a.address;c=this.eth.contract(a["interface"]).at(b);e=c.abi;a=0;for(b=e.length;a<b;a++){d=e[a];if("event"===d.type||"function"===d.type)g=this;"event"===d.type&&(c[d.name].listen=function(a){var b;b=this(function(b,c){var d,e,f,l,m;b&&console.log("error:",b);m=[];l=Object.keys(c.args);
d=0;for(f=l.length;d<f;d++)e=l[d],m.push(g.clean_return_value(c.args[e]));return a.apply(null,k.call(m).concat([c.transactionHash],[c]))});return{stop:function(){return b.stopWatching()}}});"function"===d.type&&(c[d.name].method=d.name,c[d.name].local=function(){var a,b,c;a=2<=arguments.length?k.call(arguments,0,c=arguments.length-1):(c=0,[]);b=arguments[c++];return this.call.apply(this,k.call(a).concat([function(a){return function(a,c){var d,e,f,h;if(null!=a)return console.error(a);try{return d=
g.decode(c),b(d)}catch(k){h=[];e=0;for(f=c.length;e<f;e++)d=c[e],h.push(g.clean_return_value(d));return b.apply(null,h)}}}(this)]))},c[d.name].send=function(){var a,b,d,e;e=arguments[0];a=3<=arguments.length?k.call(arguments,1,b=arguments.length-1):(b=1,[]);b=arguments[b++];d=this.method+"_callback";return d in c?(d=c[d](),g.remote_transaction.apply(g,[g,c.address,this,e,{returns:!0,event:d}].concat(k.call(a),[b]))):g.remote_transaction.apply(g,[g,c.address,this,e,{returns:!1}].concat(k.call(a),[b]))},
c[d.name].remote=function(){var a,b,d;a=2<=arguments.length?k.call(arguments,0,b=arguments.length-1):(b=0,[]);b=arguments[b++];d=this.method+"_callback";return d in c?(d=c[d](),g.remote_transaction.apply(g,[g,c.address,this,{},{returns:!0,event:d}].concat(k.call(a),[b]))):g.remote_transaction.apply(g,[g,c.address,this,{},{returns:!1}].concat(k.call(a),[b]))})}return c};f.prototype.remote_transaction=function(){var a,b,c,f,e,d,h,l;d=arguments[0];a=arguments[1];l=arguments[2];e=arguments[3];f=arguments[4];
b=7<=arguments.length?k.call(arguments,5,h=arguments.length-1):(h=5,[]);c=arguments[h++];b=l.getData.apply(l,b);h="value"in e?e.value:0;e="gas"in e?e.gas:d.eth.estimateGas({to:a,data:b});a={from:d.account(),to:a,value:h,data:b,gas:e};return d.eth.sendTransaction(a,function(a,b){return null!=a?console.log("Could not execute transaction",a):f.returns?f.event.watch(function(a,d){var e,h,l,n,p;if(a)return console.log("error:",a);if(d.transactionHash===b){f.event.stopWatching();p=[];n=Object.keys(d.args);
e=0;for(l=n.length;e<l;e++)h=n[e],p.push(d.args[h]);return c.apply(null,k.call(p).concat([b]))}}):d.check_mined(b,c)})};f.prototype.check_mined=function(a,b){return this.eth.getTransactionReceipt(a,function(c){return function(f,e){return null!=e?c.eth.getTransaction(e.transactionHash,function(c,f){var g,k;for(g in f)k=f[g],e[g]=k;return b(a,e)}):c.timeout(1E3,function(){return c.check_mined(a,b)})}}(this))};f.prototype.create_account=function(a){return{send:function(b,c){return this.eth.sendTransaction({from:this.account,
to:a,value:b,gas:2E6},function(a,b){return a?console.log(a):c(b)})}}};f.prototype.http=function(a,b){this.request_http=require("request");return this.request_http(a,function(a,f,e){if(!a&&200===f.statusCode)return b(f.body)})};f.prototype.timeout=function(a,b){return setTimeout(function(){return b()},a)};f.prototype.decode=function(a){return JSON.parse(a)};f.prototype.encode=function(a){return JSON.stringify(a)};f.prototype.node_address=function(a,b){return"http://"+a+":"+b};f.prototype.accounts=
function(){return this.eth.accounts};f.prototype.account=function(){return this.eth.accounts[0]};f.prototype.random_int=function(a,b){null==b&&(b=0);return Math.floor(Math.random()*(a-b)+b)};f.prototype.sec_to_ms=function(a){return 1E3*a};f.prototype.now=function(){return Math.round((new Date).getTime()/1E3)};return f}();module.exports=q}).call(this);
